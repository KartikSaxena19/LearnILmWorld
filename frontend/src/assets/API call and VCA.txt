package com.example.learnilmdummy.data

import com.example.learnilmdummy.data.TokenApi
import okhttp3.OkHttpClient
import okhttp3.logging.HttpLoggingInterceptor
import retrofit2.Retrofit
import retrofit2.converter.gson.GsonConverterFactory

object RetrofitClient {
    private const val BASE_URL = "http://10.83.61.15:3000/"
    // For real device: "http://192.168.x.x:3000/"

    private val loggingInterceptor = HttpLoggingInterceptor().apply {
        level = HttpLoggingInterceptor.Level.BODY
    }

    private val client = OkHttpClient.Builder()
        .addInterceptor(loggingInterceptor)
        .build()

    val api: TokenApi = Retrofit.Builder()
        .baseUrl(BASE_URL)
        .client(client)
        .addConverterFactory(GsonConverterFactory.create())
        .build()
        .create(TokenApi::class.java)
}

package com.example.learnilmdummy

import android.os.Bundle
import android.util.Log
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.example.learnilmdummy.data.RetrofitClient
import com.example.learnilmdummy.data.TokenResponse
import com.zegocloud.uikit.components.audiovideocontainer.ZegoLayout
import com.zegocloud.uikit.components.audiovideocontainer.ZegoLayoutGalleryConfig
import com.zegocloud.uikit.components.audiovideocontainer.ZegoLayoutMode
import com.zegocloud.uikit.components.common.ZegoShowFullscreenModeToggleButtonRules
import com.zegocloud.uikit.prebuilt.call.ZegoUIKitPrebuiltCallConfig
import com.zegocloud.uikit.prebuilt.call.ZegoUIKitPrebuiltCallFragment
import com.zegocloud.uikit.prebuilt.call.config.ZegoMenuBarButtonName
import retrofit2.Call
import retrofit2.Callback
import retrofit2.Response

class VideoCallActivity : AppCompatActivity() {

    private val appID: Long = 1029743296L // Your Zego AppID

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_video_call)

        val role = intent.getStringExtra("ROLE") ?: run { finish(); return }
        val userId = intent.getStringExtra("USER_ID") ?: run { finish(); return }
        val userName = intent.getStringExtra("USER_NAME") ?: run { finish(); return }
        val sessionId = intent.getStringExtra("SESSION_ID") ?: run { finish(); return }

        Toast.makeText(this, "Joining session...", Toast.LENGTH_SHORT).show()

        // Fetch token using Retrofit
        fetchToken(
            userId = userId,
            onSuccess = { token ->
                addCallFragment(role, userId, userName, sessionId, token)
            },
            onFailure = { error ->
                Log.e("VideoCallActivity", "Failed to fetch token: $error")
                Toast.makeText(this, "Failed to connect: $error", Toast.LENGTH_LONG).show()
                finish()
            }
        )
    }

    private fun fetchToken(
        userId: String,
        onSuccess: (String) -> Unit,
        onFailure: (String) -> Unit
    ) {
        val requestBody = mapOf("userId" to userId)

        RetrofitClient.api.getToken(requestBody).enqueue(object : Callback<TokenResponse> {
            override fun onResponse(call: Call<TokenResponse>, response: Response<TokenResponse>) {
                if (response.isSuccessful && response.body()?.token != null) {
                    onSuccess(response.body()!!.token)
                } else {
                    val errorMsg = response.errorBody()?.string() ?: response.message()
                    onFailure("Server error: ${response.code()} - $errorMsg")
                }
            }

            override fun onFailure(call: Call<TokenResponse>, t: Throwable) {
                onFailure("Network error: ${t.message ?: "Unknown error"}")
            }
        })
    }

    private fun addCallFragment(
        role: String,
        userId: String,
        userName: String,
        sessionId: String,
        token: String
    ) {
        val config = ZegoUIKitPrebuiltCallConfig.oneOnOneVideoCall()

        // Customize for tutoring experience
        config.turnOnCameraWhenJoining = true
        config.turnOnMicrophoneWhenJoining = true
        config.useSpeakerWhenJoining = true

        val galleryConfig = ZegoLayoutGalleryConfig()
        // Optional: Auto-switch to fullscreen when screen sharing starts
        galleryConfig.showNewScreenSharingViewInFullscreenMode = true
        // Optional: Show toggle button for fullscreen when screen is pressed
        galleryConfig.showScreenSharingFullscreenModeToggleButtonRules =
            com.zegocloud.uikit.components.common.ZegoShowFullscreenModeToggleButtonRules.SHOW_WHEN_SCREEN_PRESSED
        config.layout = ZegoLayout(ZegoLayoutMode.GALLERY, galleryConfig)

        config.bottomMenuBarConfig.buttons = mutableListOf(
            ZegoMenuBarButtonName.TOGGLE_CAMERA_BUTTON,
            ZegoMenuBarButtonName.TOGGLE_MICROPHONE_BUTTON,
            ZegoMenuBarButtonName.SWITCH_CAMERA_BUTTON,
            ZegoMenuBarButtonName.HANG_UP_BUTTON,
            ZegoMenuBarButtonName.SCREEN_SHARING_TOGGLE_BUTTON
        )

        val fragment = ZegoUIKitPrebuiltCallFragment.newInstanceWithToken(
            appID,
            token,
            userId,
            userName,
            sessionId,
            config
        )

        supportFragmentManager.beginTransaction()
            .replace(R.id.fragment_container, fragment)
            .addToBackStack("call_fragment") // Prevents instant jump back
            .commit()
    }

    // Remove or comment this out â€“ Zego handles back press better internally
    // override fun onBackPressed() {
    //     super.onBackPressed()
    //     finish()
    // }
}
